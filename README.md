# WEB_prj
Вся информация анонимизирована.

***Содержание:***
- [Вступление](#Introduction)
- [Запуск](#Starting)
- [При запуске](#After-Starting)
- [Описание программы для пользователя](#User-Descrip)
- [Документация к апи](#Api-Doc)
- [Конфигурация ПК](#Config)
- [Описание некоторых алгоритмов проекта](#Descrip-some-algorithms)
- [Описание реализации некоторых алгоритмов проекта](#Descrip-implem-some-algorithms)
- [Заключение](#End)

<h3>Вступление</h3><a name='Introduction'></a>

"FilmCenter" - сайт на Flask от 3-х creative developers.

Перед нами стояла цель разработать сайт в сети интернет, 
который предоставит пользователю возможность ознакомиться с фильмами, 
которые находятся в прокате кинотеатра, а также оформить бронь одного 
или нескольких мест на сеанс выбранного фильма.

<h5>ТЗ:</h5>
1) Написать сайт с использованием Flask и RESTful-api.<br>
2) Реализовать RESTful-api для проекта.<br>
3) Реализовать юзер и админ части проекта.<br>

<a href='https://drive.google.com/file/d/1Mmy5mVYOe4CZ60eZ7nnObOy0k8Jy3q4p/view?usp=sharing'><h4>Видео демонстрация</h4></a>

**Программа имеет функции:<br>**
•   Показ доступных фильмов.<br>
•	Поиск интересующего фильма через возможности встроенного фильтра и поисковую строку.<br>
•	Просмотр описания, трейлеров, а также изображений фильмов.<br>
•	Заказ билетов на фильм.<br>
•	Отправка билетов на почту.<br>
•	Добавление новых фильмов и редактирование старых.<br>
•	Ручное и автоматическое создание сессий для фильмов.<br>

**Программа состоит из:<br>**
•	Пользовательского интерфейса<br>
•	Администраторского интерфейса

Для того чтобы более точно определить последовательности действий, которые может осуществлять система в ответ на внешние воздействия пользователей была составлена диаграмма вариантов использования.
Диаграмма вариантов использования представлена на рисунке 2.2.<br>
<p><img src="Readme_images/usage_variants.png" alt='Диаграмма вариантов использования' width='600'/></p>
Рисунок 2.2 — Диаграмма вариантов использования.<br><br>

Проект представляет собой сайт, в котором пользователь может ознакомиться с доступными фильмами и выбрать интересующий его фильм или подобрать фильм по нескольким критериям (год, жанр, продолжительность, режиссер). Выбрав фильм, пользователь может узнать краткое описание и жанр, длительность, год премьеры, а также актеров, принимавших участие в фильме, и режиссера. Кроме этого пользователь может ознакомиться с несколькими кадрами из фильма и трейлером к фильму. Ознакомившись, пользователь может забронировать билет. Для этого необходимо выбрать удобную дату, доступное время на сеанс и место в зале. Перед подтверждением брони пользователю необходимо ввести адрес электронной почты, на которую будут высланы билеты. Далее пользователь может, как заказать билеты на другое время или дату, так и вернуться к списку всех доступных фильмов в прокате. 
Также проект подразумевает и работу администратора с базой данных. У администратора имеется доступ ко всем использующимся таблицам в проекте. Администратор может изменять, добавлять новые и удалять старые элементы. Кроме этого администратор имеет возможность сформировать новое расписание на неделю вперед или же вручную добавить сеанс в базу.

**_Ниже будут приведены описания некоторых алгоритомов, а также описание их реализации.<br>
Однако ознакомиться с более подробным описанием нашего проекта можно в пояснительный записке к проекту (см. файл PZ_web.docx)._**

<h3>Запуск</h3><a name='Starting'></a>
<h6><a href='http://film-center-prj.herokuapp.com/'>Ознакомиться с сайтом на Heroku</a></h6>

<h5>Запуск из кода</h5><a name='Starting'></a>
Все необходимые библиотеки описаны в requirements.txt. <br><br>

<i><b>Чтобы запустить сайт необходимо запустить файл app.py в корне проекта.</b></i>

В нашем проекте реализована система бронирования билетов и отправка их на почту.<br>
<i><b>Поэтом перед запуском проверьте .env файл:
1) Замените PASSWORD_EMAIL на пароль к почте, с которой будут отправляться письма
2) Замените EMAIL на email той почты, с которой будут отправляться письма</b></i> 

<small>Данный вариант нашего проекта использует бд типа SQLITE с небольшим количеством тестовых данный. 
Однако версия, которая работает на Heroku использует POSTGRESQL бд, что обусловлено 
техническими ограничениями платформы Heroku. Но несмотря на это, все 
функции работают стабильно и не зависят от типа бд.</small>

<h3>При запуске</h3><a name='After-Starting'></a>
<h5>Что вкратце происходит после запуска app.py</h5>

1. Создается объект таймера, который будет каждый вторник и пятницу в 15:00 очищать базу от устаревших данных.
2. Приложение подключается к базе данных.
3. Происходит создание администраторского интерфейса.
4. К приложению подключаются разработанные апи на blueprint и RESTful-api.
5. Сервер запускается и начинает ожидать входящих запросов для их последующей обработки. 

Для того, чтобы попасть в интерфейс администратора - необходимо перейти по адресу - /admin.
Если ранее Вы не входили в систему, то потребуется ввести логин и пароль.
* логин - admin, пароль - admin.

Теперь, если Вам потребуется разлогиниться из администратора, то необходимо перейти по адресу - /logout

<h3>Описание программы для пользователя</h3><a name='User-Descrip'></a>
Проект представляет собой многостраничный сайт, в котором пользователь может ознакомиться с доступными фильмами и выбрать интересующий его фильм или подобрать фильм по нескольким критериям (год, жанр, продолжительность, режиссер). Выбрав фильм, пользователь может узнать краткое описание и жанр, длительность, год премьеры, а также актеров, принимавших участие в фильме, и режиссера. Кроме этого пользователь может ознакомиться с несколькими кадрами из фильма и трейлером к фильму. Ознакомившись, пользователь может забронировать билет. Для этого необходимо выбрать удобную дату, доступное время на сеанс и место в зале. Перед подтверждением брони пользователю необходимо ввести адрес электронной почты, на которую будут высланы билеты. Далее пользователь может, как заказать билеты на другое время или дату, так и вернуться к списку всех доступных фильмов в прокате.
<br><br>
После перехода по ссылке откроется главная страница сайта. Изображение главной страницы представлено на  рисунке 3.1. 
<br>![Изображение главной страницы сайта](Readme_images/main_page.png)<br>
Рисунок 3.1 – Изображение главной страницы сайта.<br><br>

В верхней части сайта находится панель с кнопкой открытия фильтра и поисковой строкой. Изображение панели представлено на рисунке 3.2.
<br>![Панель](Readme_images/panel.png)<br>
Рисунок 3.2 — Панель.

Чтобы вернуться на главную страницу необходимо нажать на ссылку «FilmCenter». Изображение ссылки представлено на рисунке  3.2.0.
<br>![Изображение ссылки, ведущей на главную страницу](Readme_images/mp_url.png)<br>
Рисунок 3.2.0 – Изображение ссылки, ведущей на главную страницу.

Чтобы настроить фильтр нужно нажать кнопку «Фильтр». После появится блок с настройками поиска. 
Чтобы выбрать, по какому параметру искать фильм необходимо выбрать нужный чекбокс и поставить в нем галочку, а также выбрать нужный элемент из выпадающего списка. Изображение окна фильтра представлено на рисунке 3.2.1.
<br>![Изображение фильтра](Readme_images/filter.png)<br>
Рисунок 3.2.1. — Изображение фильтра.

Чтобы перейти к более подробному описанию фильма необходимо нажать на карточку фильма. Изображение примера карточки представлено на рисунке 3.3.1. Изображение страницы с более подробным описанием фильма представлено на рисунке 3.3.2. 
<br>![Изображение примера карточки](Readme_images/card.png)<br>
Рисунок 3.3.1. — Изображение примера карточки.
<br>![Изображение страницы с более подробным описанием фильма](Readme_images/full_card.png)<br>
Рисунок 3.3.2. — Изображение страницы с более подробным описанием фильма.

Для бронирования билета необходимо нажать кнопку «Забронировать билет». В открывшейся странице необходимо выбрать дату и нажать на доступное время, чтобы продолжить. Изображение страницы с расписаниями представлено на рисунке 3.4.
<br>![Изображение страницы с расписаниями](Readme_images/timetable.png)<br>
Рисунок 3.4 – Изображение страницы с расписаниями. 

После выбора места откроется страница с выбором мест в зале. Можно выбрать неограниченное количество мест. И чтобы продолжить необходимо нажать кнопку «Продолжить». Изображение страницы с выбором мест представлено на рисунке 3.5. 
<br>![Изображение страницы с выбором мест](Readme_images/hallplan.png)<br>
Рисунок 3.5 – Изображение страницы с выбором мест.

После нажатия кнопки «Продолжить» открывается окно с полем для ввода почты и галочкой подтверждения бронирования. Также в окне можно наблюдать выбранные билеты. Если необходимо удалить какой-либо билет, то нужно нажать на его крестик. Если удалены все билеты, то снова откроется окно с выбором мест в зале. Изображение страницы с подтверждением брони показано на рисунке 3.6.
<br>![Изображение страницы с подтверждением брони](Readme_images/pay_check.png)<br>
Рисунок 3.6 – Изображение страницы с подтверждением брони.

После ввода всех данных и нажатия кнопки «Подтвердить», откроется страница с расписанием и всплывет уведомление в правом верхнем углу, подсказывающее пользователю, что билеты были отправлены на почту. Изображения страницы с всплывающим уведомлением представлено на рисунке 3.7.
<br>![Изображение страницы с всплывающим уведомлением](Readme_images/pop-up_notification.png)<br>
Рисунок 3.7 – Изображение страницы с всплывающим уведомлением.

Теперь проверим почту, и увидим, что пришло письмо с картинками заказанных билетов. Изображение письма представлено на рисунке 3.8.
<br>![Изображение письма от приложения](Readme_images/letter.png)<br>
Рисунок 3.8 – Изображение письма от приложения.

Изображение билета представлено на рисунке 3.9. Билет содержит qrcode с уникальным идентификационным кодом, подтверждающий заказ билета.
<br>![Изображение билета](Readme_images/ticket.png)<br>
Рисунок 3.9 – Изображение билета.  

<h3>Документация к апи</h3><a name='Api-Doc'></a>
В нашем проекте доступно апи для работы с фильмами. <br>
- Поиск фильмов в бд по названию, году, жанру, режиссеру, длительности.
- Получение фильма по id.
- Изменение фильма по id.
- Удаление фильма по id.
- Получение списка всех фильмов.
- Добавление нового фильма.
- Получение списка "новинок" из базы и самых просматриваемых фильмов. Новинки - фильмы, у которых премьера была в текущем месяце.
- Получение списка параметров для фильтрации (доступные в базе даты премьер, доступные жанры, режиссеры, длительности).

**1. Поиск фильмов по параметрам.**
- Адрес запроса: `/api/films/filtered `. 
- Параметры запроса:
    - data может содержать следующие параметры:
        - title (название фильма)
        - year_cb (Параметр, сообщающий, что необходимо применить аналогичный параметр, но без _cb)
        - year (Год премьеры фильма)
        - genre_cb (Аналогично, что и в year_cb)
        - genre (Жанр фильма в нижнем регистре)
        - duration_cb (Аналогично, что и в year_cb)
        - duration (Продолжительность фильма в минутах)
        - producer_cb (Аналогично, что и в year_cb)
        - producer (Имя продюсера)
- **_Пример запроса:_**<br>
    ```
    data = {
        'genre_cb': 'on',
        'genre': 'комедия'
    }
    resp = requests.get('http://localhost:5000/api/films/filtered', data=data).json()
    ```
- В случае удачи возвращает список с фильмами. 
    <br>_**Пример ответа сервера:**_<br>
    ```
    {'films': [{'actors': 'Александр Демьяненко, Юрий Яковлев, Леонид Куравлёв',
            'description': 'Иван Грозный отвечает на телефон, пока его '
                           'тезка-пенсионер сидит на троне. ',
            'duration': 88,
            'genre': [{'name': 'приключения'},
                      {'name': 'фантастика'},
                      {'name': 'комедия'}],
            'id': 1,
            'images': [{'image_url': 'https://osssr.ru/wp-content/uploads/2020/12/Ivan-Vasilevich-menyaet-professiyu.jpg'},
                       {'image_url': 'https://image.tmdb.org/t/p/original/fhxVCWgXrtKEwETL0Ncgn3R1u27.jpg'},
                       {'image_url': 'https://s.fishki.net/upload/users/2018/06/23/1094875/5a74ba88e39f51c8a797b616b0b6759d.jpg'}],
            'poster_url': 'https://avatars.mds.yandex.net/get-kinopoisk-image/1900788/045a3315-e32b-494e-ab6d-4deb55f0fc25/800x800',
            'premiere': '2021-04-13',
            'producer': 'Леонид Гайдай',
            'rating': 8.8,
            'title': 'Иван Васильевич меняет профессию',
            'trailer_url': 'https://www.youtube.com/embed/vDpERQZlvGc',
            'watchers': 3},
           {'actors': 'Леонид Быков, Сергей Подгорный, Сергей Иванов',
            'description': 'Фильм, повествующий о буднях лётчиков-истребителей '
                           'в годы Великой Отечественной войны.',
            'duration': 87,
            'genre': [{'name': 'драма'},
                      {'name': 'военный'},
                      {'name': 'комедия'}],
            'id': 2,
            'images': [{'image_url': 'https://avatars.mds.yandex.net/get-kinopoisk-blog-post-thumb/17811/c5a957d6c99fb92d6eb1e347e0f293b2/orig'},
                       {'image_url': 'https://c.radikal.ru/c27/1902/40/d5331a8a9a72.png'},
                       {'image_url': 'https://s.fishki.net/upload/users/2016/03/10/1094843/a178db596a7762fba962f68b7ab726b1.png'}],
            'poster_url': 'https://avatars.mds.yandex.net/get-kinopoisk-image/1704946/03265560-cacb-429a-8ccd-50403f2db552/300x450',
            'premiere': '2021-04-13',
            'producer': 'Леонид Быков',
            'rating': 8.7,
            'title': 'В бой идут одни старики',
            'trailer_url': 'https://www.youtube.com/embed/f7yNEcr7Bvg',
            'watchers': 0}
            ]
    }
    ```
**2. Получение фильма по id**
- Адрес запроса: `/api/films/<int:film_id>`. 
- Параметры:
    - Веместо film_id в ссылке необходимо передать id интересующего фильма.
- _**Пример запроса:**_
    ```
    resp = requests.get('http://localhost:5000//api/films/1').json()
    ```
- _**Пример ответа:**_
    ```
    {
    "film": {
        "actors": "Александр Демьяненко, Юрий Яковлев, Леонид Куравлёв",
        "description": "Иван Грозный отвечает на телефон, пока его тезка-пенсионер сидит на троне. ",
        "duration": 88,
        "genre": [
            {
                "name": "приключения"
            },
            {
                "name": "фантастика"
            },
            {
                "name": "комедия"
            }
        ],
        "id": 1,
        "images": [
            {
                "image_url": "https://osssr.ru/wp-content/uploads/2020/12/Ivan-Vasilevich-menyaet-professiyu.jpg"
            },
            {
                "image_url": "https://image.tmdb.org/t/p/original/fhxVCWgXrtKEwETL0Ncgn3R1u27.jpg"
            },
            {
                "image_url": "https://s.fishki.net/upload/users/2018/06/23/1094875/5a74ba88e39f51c8a797b616b0b6759d.jpg"
            }
        ],
        "poster_url": "https://avatars.mds.yandex.net/get-kinopoisk-image/1900788/045a3315-e32b-494e-ab6d-4deb55f0fc25/800x800",
        "premiere": "2021-04-13",
        "producer": "Леонид Гайдай",
        "rating": 8.8,
        "title": "Иван Васильевич меняет профессию",
        "trailer_url": "https://www.youtube.com/embed/vDpERQZlvGc",
        "watchers": 4
        }
    }
    ```
  
**3. Получение списка всех фильмов**
- Адрес запроса: `/api/films`. 
- _**Пример запроса:**_
    ```
    resp = requests.get('http://localhost:5000//api/films').json()
    ```
- _**Пример ответа:**_
    ```
    {
    "films": [
        {
            "actors": "Александр Демьяненко, Юрий Яковлев, Леонид Куравлёв",
            "description": "Иван Грозный отвечает на телефон, пока его тезка-пенсионер сидит на троне. ",
            "duration": 88,
            "genre": [
                {
                    "name": "приключения"
                },
                {
                    "name": "фантастика"
                },
                {
                    "name": "комедия"
                }
            ],
            "id": 1,
            "images": [
                {
                    "image_url": "https://osssr.ru/wp-content/uploads/2020/12/Ivan-Vasilevich-menyaet-professiyu.jpg"
                },
                {
                    "image_url": "https://image.tmdb.org/t/p/original/fhxVCWgXrtKEwETL0Ncgn3R1u27.jpg"
                },
                {
                    "image_url": "https://s.fishki.net/upload/users/2018/06/23/1094875/5a74ba88e39f51c8a797b616b0b6759d.jpg"
                }
            ],
            "poster_url": "https://avatars.mds.yandex.net/get-kinopoisk-image/1900788/045a3315-e32b-494e-ab6d-4deb55f0fc25/800x800",
            "premiere": "2021-04-13",
            "producer": "Леонид Гайдай",
            "rating": 8.8,
            "title": "Иван Васильевич меняет профессию",
            "trailer_url": "https://www.youtube.com/embed/vDpERQZlvGc",
            "watchers": 4
        },
        {
            "actors": "Леонид Быков, Сергей Подгорный, Сергей Иванов",
            "description": "Фильм, повествующий о буднях лётчиков-истребителей в годы Великой Отечественной войны.",
            "duration": 87,
            "genre": [
                {
                    "name": "драма"
                },
                {
                    "name": "военный"
                },
                {
                    "name": "комедия"
                }
            ],
            "id": 2,
            "images": [
                {
                    "image_url": "https://avatars.mds.yandex.net/get-kinopoisk-blog-post-thumb/17811/c5a957d6c99fb92d6eb1e347e0f293b2/orig"
                },
                {
                    "image_url": "https://c.radikal.ru/c27/1902/40/d5331a8a9a72.png"
                },
                {
                    "image_url": "https://s.fishki.net/upload/users/2016/03/10/1094843/a178db596a7762fba962f68b7ab726b1.png"
                }
            ],
            "poster_url": "https://avatars.mds.yandex.net/get-kinopoisk-image/1704946/03265560-cacb-429a-8ccd-50403f2db552/300x450",
            "premiere": "2021-04-13",
            "producer": "Леонид Быков",
            "rating": 8.7,
            "title": "В бой идут одни старики",
            "trailer_url": "https://www.youtube.com/embed/f7yNEcr7Bvg",
            "watchers": 0
        },
        {
            "actors": "Элайджа Вуд, Иэн Маккеллен, Вигго Мортенсен",
            "description": "Братство распалось, но Кольцо Всевластья должно быть уничтожено. Фродо и Сэм вынуждены доверить свои жизни Голлуму, который взялся провести их к вратам Мордора. Громадная армия Сарумана приближается: члены братства и их союзники готовы принять бой. Битва за Средиземье продолжается.",
            "duration": 179,
            "genre": [
                {
                    "name": "драма"
                },
                {
                    "name": "фэнтези"
                },
                {
                    "name": "приключения"
                }
            ],
            "id": 3,
            "images": [
                {
                    "image_url": "https://i.playground.ru/p/sP6PsThCc1k0qJKomMAMsA.jpeg"
                },
                {
                    "image_url": "https://image.tmdb.org/t/p/original/iqcUExVWxXOo0oVxwWQRo3MXEh2.jpg"
                },
                {
                    "image_url": "https://wallup.net/wp-content/uploads/2019/07/24/179326-lord-of-the-rings-lotr-fantasy-two-towers-adventure-warrior.jpg"
                }
            ],
            "poster_url": "https://upload.wikimedia.org/wikipedia/ru/f/f0/The_Lord_of_the_Rings._The_Two_Towers_—_movie.jpg",
            "premiere": "2021-05-04",
            "producer": "Питер Джексон",
            "rating": 8.6,
            "title": "Властелин колец: Две крепости",
            "trailer_url": "https://www.youtube.com/embed/n8EaedqFfuU",
            "watchers": 1
            }
        ]
    }
    ```
  
**4. Изменение фильма по id**
- Адрес запроса: `/api/films/<int:film_id>`.
- Параметры:
    - title (Название) - строка - ОБЯЗАТЕЛЬНО
    - duration (Продолжительность) - INTEGER - ОБЯЗАТЕЛЬНО
    - actors (Актеры) - строка - НЕОБЯЗАТЕЛЬНО
    - producer (Режиссеры) - строка - НЕОБЯЗАТЕЛЬНО
    - description (Описание) - строка - НЕОБЯЗАТЕЛЬНО
    - premiere (Дата премьеры) - строка. Формат даты: год-месяц-день - НЕОБЯЗАТЕЛЬНО
    - watchers (Просмотры) - НЕОБЯЗАТЕЛЬНО - INTEGER - по-умолчанию 0 - НЕОБЯЗАТЕЛЬНО
    - trailer_url (Ссылка на трейлер) - НЕОБЯЗАТЕЛЬНО - строка - по-умолчанию NONE
    - poster_url (Ссылка на постер) - НЕОБЯЗАТЕЛЬНО - строка - по-умолчанию NONE
    - rating (Рейтинг) - НЕОБЯЗАТЕЛЬНО - FLOAT - по-умолчанию 0.0
    - images (Список картинок) - НЕОБЯЗАТЕЛЬНО - список - по-умолчанию пустой список
    - genres (Список жанров) - НЕОБЯЗАТЕЛЬНО - список - по-умолчанию пустой список
- **_Пример запроса:_**
    ```
    params = {"premiere": "2021-05-13", "title": "Иван Васильевич меняет профессию", "duration": 88}
    resp = requests.put('http://localhost:5000//api/films/1', params=params).json()
    ```
- **_Пример ответа:_**
    ```
    {
    "success": "OK"
    }
    ```
**5. Удаление фильма по id.**
- Адрес запроса: `/api/films/<int:film_id>`.
- Параметры:
    - Веместо film_id в ссылке необходимо передать id интересующего фильма.
- _**Пример запроса:**_
    ```
    resp = requests.delete('http://localhost:5000//api/films/1').json()
    ```
- **_Пример ответа:_**
     ```
    {
    "success": "OK"
    }
    ```
**6. Добавление нового фильма.**
- Адрес запроса: `/api/films/<int:film_id>`. 
- Параметры:
    - title (Название) - строка - ОБЯЗАТЕЛЬНО
    - duration (Продолжительность) - INTEGER - ОБЯЗАТЕЛЬНО
    - actors (Актеры) - строка - НЕОБЯЗАТЕЛЬНО
    - producer (Режиссеры) - строка - НЕОБЯЗАТЕЛЬНО
    - description (Описание) - строка - НЕОБЯЗАТЕЛЬНО
    - premiere (Дата премьеры) - строка. Формат даты: год-месяц-день - НЕОБЯЗАТЕЛЬНО
    - watchers (Просмотры) - НЕОБЯЗАТЕЛЬНО - INTEGER - по-умолчанию 0 - НЕОБЯЗАТЕЛЬНО
    - trailer_url (Ссылка на трейлер) - НЕОБЯЗАТЕЛЬНО - строка - по-умолчанию NONE
    - poster_url (Ссылка на постер) - НЕОБЯЗАТЕЛЬНО - строка - по-умолчанию NONE
    - rating (Рейтинг) - НЕОБЯЗАТЕЛЬНО - FLOAT - по-умолчанию 0.0
    - images (Список картинок) - НЕОБЯЗАТЕЛЬНО - список - по-умолчанию пустой список
    - genres (Список жанров) - НЕОБЯЗАТЕЛЬНО - список - по-умолчанию пустой список
- **_Пример запроса:_**
    ```
    params = {"premiere": "2021-05-13", "title": "Cyberpunk2077", "duration": 888}
    resp = requests.post('http://localhost:5000//api/films', params=params).json()
    ```
- **_Пример ответа:_**
     ```
    {
    "success": "OK"
    }
    ```
**7. Получение списка "новинок" из базы и самых просматриваемых фильмов.**
- Адрес запроса: `/api/films/recommendations`. 
- _**Пример запроса:_**   
    ```
    resp = requests.get('http://localhost:5000//api/films/recommendations').json()
    ```
- **_Пример ответа:_**
     ```
    {
    "most_watched_films": [
        {
            "actors": "Элайджа Вуд, Иэн Маккеллен, Вигго Мортенсен",
            "description": "Братство распалось, но Кольцо Всевластья должно быть уничтожено. Фродо и Сэм вынуждены доверить свои жизни Голлуму, который взялся провести их к вратам Мордора. Громадная армия Сарумана приближается: члены братства и их союзники готовы принять бой. Битва за Средиземье продолжается.",
            "duration": 179,
            "genre": [
                {
                    "name": "драма"
                },
                {
                    "name": "фэнтези"
                },
                {
                    "name": "приключения"
                }
            ],
            "id": 3,
            "images": [
                {
                    "image_url": "https://i.playground.ru/p/sP6PsThCc1k0qJKomMAMsA.jpeg"
                },
                {
                    "image_url": "https://image.tmdb.org/t/p/original/iqcUExVWxXOo0oVxwWQRo3MXEh2.jpg"
                },
                {
                    "image_url": "https://wallup.net/wp-content/uploads/2019/07/24/179326-lord-of-the-rings-lotr-fantasy-two-towers-adventure-warrior.jpg"
                }
            ],
            "poster_url": "https://upload.wikimedia.org/wikipedia/ru/f/f0/The_Lord_of_the_Rings._The_Two_Towers_—_movie.jpg",
            "premiere": "2021-05-04",
            "producer": "Питер Джексон",
            "rating": 8.6,
            "title": "Властелин колец: Две крепости",
            "trailer_url": "https://www.youtube.com/embed/n8EaedqFfuU",
            "watchers": 1
        },
        {
            "actors": "",
            "description": "",
            "duration": 88,
            "genre": [
                {
                    "name": "приключения"
                },
                {
                    "name": "фантастика"
                },
                {
                    "name": "комедия"
                }
            ],
            "id": 1,
            "images": [
                {
                    "image_url": "https://osssr.ru/wp-content/uploads/2020/12/Ivan-Vasilevich-menyaet-professiyu.jpg"
                },
                {
                    "image_url": "https://image.tmdb.org/t/p/original/fhxVCWgXrtKEwETL0Ncgn3R1u27.jpg"
                },
                {
                    "image_url": "https://s.fishki.net/upload/users/2018/06/23/1094875/5a74ba88e39f51c8a797b616b0b6759d.jpg"
                }
            ],
            "poster_url": null,
            "premiere": "2021-05-13",
            "producer": "",
            "rating": 0.0,
            "title": "Иван Васильевич меняет профессию",
            "trailer_url": null,
            "watchers": 0
        },
        {
            "actors": "Леонид Быков, Сергей Подгорный, Сергей Иванов",
            "description": "Фильм, повествующий о буднях лётчиков-истребителей в годы Великой Отечественной войны.",
            "duration": 87,
            "genre": [
                {
                    "name": "драма"
                },
                {
                    "name": "военный"
                },
                {
                    "name": "комедия"
                }
            ],
            "id": 2,
            "images": [
                {
                    "image_url": "https://avatars.mds.yandex.net/get-kinopoisk-blog-post-thumb/17811/c5a957d6c99fb92d6eb1e347e0f293b2/orig"
                },
                {
                    "image_url": "https://c.radikal.ru/c27/1902/40/d5331a8a9a72.png"
                },
                {
                    "image_url": "https://s.fishki.net/upload/users/2016/03/10/1094843/a178db596a7762fba962f68b7ab726b1.png"
                }
            ],
            "poster_url": "https://avatars.mds.yandex.net/get-kinopoisk-image/1704946/03265560-cacb-429a-8ccd-50403f2db552/300x450",
            "premiere": "2021-04-13",
            "producer": "Леонид Быков",
            "rating": 8.7,
            "title": "В бой идут одни старики",
            "trailer_url": "https://www.youtube.com/embed/f7yNEcr7Bvg",
            "watchers": 0
        }
    ],
    "new_films": [
        {
            "actors": "",
            "description": "",
            "duration": 88,
            "genre": [
                {
                    "name": "приключения"
                },
                {
                    "name": "фантастика"
                },
                {
                    "name": "комедия"
                }
            ],
            "id": 1,
            "images": [
                {
                    "image_url": "https://osssr.ru/wp-content/uploads/2020/12/Ivan-Vasilevich-menyaet-professiyu.jpg"
                },
                {
                    "image_url": "https://image.tmdb.org/t/p/original/fhxVCWgXrtKEwETL0Ncgn3R1u27.jpg"
                },
                {
                    "image_url": "https://s.fishki.net/upload/users/2018/06/23/1094875/5a74ba88e39f51c8a797b616b0b6759d.jpg"
                }
            ],
            "poster_url": null,
            "premiere": "2021-05-13",
            "producer": "",
            "rating": 0.0,
            "title": "Иван Васильевич меняет профессию",
            "trailer_url": null,
            "watchers": 0
        },
        {
            "actors": "Элайджа Вуд, Иэн Маккеллен, Вигго Мортенсен",
            "description": "Братство распалось, но Кольцо Всевластья должно быть уничтожено. Фродо и Сэм вынуждены доверить свои жизни Голлуму, который взялся провести их к вратам Мордора. Громадная армия Сарумана приближается: члены братства и их союзники готовы принять бой. Битва за Средиземье продолжается.",
            "duration": 179,
            "genre": [
                {
                    "name": "драма"
                },
                {
                    "name": "фэнтези"
                },
                {
                    "name": "приключения"
                }
            ],
            "id": 3,
            "images": [
                {
                    "image_url": "https://i.playground.ru/p/sP6PsThCc1k0qJKomMAMsA.jpeg"
                },
                {
                    "image_url": "https://image.tmdb.org/t/p/original/iqcUExVWxXOo0oVxwWQRo3MXEh2.jpg"
                },
                {
                    "image_url": "https://wallup.net/wp-content/uploads/2019/07/24/179326-lord-of-the-rings-lotr-fantasy-two-towers-adventure-warrior.jpg"
                }
            ],
            "poster_url": "https://upload.wikimedia.org/wikipedia/ru/f/f0/The_Lord_of_the_Rings._The_Two_Towers_—_movie.jpg",
            "premiere": "2021-05-04",
            "producer": "Питер Джексон",
            "rating": 8.6,
            "title": "Властелин колец: Две крепости",
            "trailer_url": "https://www.youtube.com/embed/n8EaedqFfuU",
            "watchers": 1
            }
        ]
    }
    ```
**8. Получение списка параметров для фильтрации .**
- Адрес запроса: `/api/filter_data`. 
- _**Пример запроса:_**   
    ```
    resp = requests.get('http://localhost:5000//api/filter_data').json()
    ```
- **_Пример ответа:_**
     ```
    {
    "filter_data": {
        "duration": [
            87,
            88,
            179
        ],
        "genres": [
            "аниме",
            "биография",
            "боевик",
            "военный",
            "детектив",
            "драма",
            "история",
            "комедия",
            "криминал",
            "мелодрама",
            "мультфильм",
            "мюзикл",
            "приключения",
            "семейный",
            "триллер",
            "фантастика",
            "фэнтези",
            "экшн"
        ],
        "producer": [
            "Леонид Быков",
            "Питер Джексон"
        ],
        "years": [
            2021
            ]
        }
    }
    ```
<h3>Конфигурация</h3><a name="Config"></a>
На приведенной ниже конфигурации было разработано приложение на Flask.

![Developer system config](Readme_images/dev_syst_conf.png "Конфигурация ПК разработчика клиента игры")

Также работа кода была протестирована на более чем 3 разных машинах, и никаких критических ошибок не было обнаружено.


<h3>Описание некоторых алгоритмов в проекте</h3><a name='Descrip-some-algorithms'></a>
_Работа с базой sqlite фактические ничем не отличается от работы с базой postgres. Различие имеется лишь в ссылке на бд.<br>
Для того, чтобы подключить свою postgres бд необходимо изменить следущую строку:<br>
sqlite = os.environ.get('SQLITE'), а именно параметр, передаваемый в get, заменить на POSTGRESQL. А также добавить корректную ссылку на postgres бд в .env файл.<br>
<br>_
**Алгоритм подключения к базе данных.<br>**
В проекте реализовано подключение к бд с помощью библиотеки Sqlalchemy. Данная библиотека позволяет подключиться к удаленной бд и создавать сессии для каких-либо изменений в бд.
Т.к. в нашем проекте использована система автоматического очищения базы данных, то появилась проблема с незакрытыми сессиями. Закрывать сессии можно как явно, вызывая метод close() у сессии, так и неявно, используя оператор with при создании сессии, который автоматически закроет сессию после завершения работы с бд. 
Итак, порядок работы с бд можно описать по следующим пунктам:
1. При создании приложения<br>
    1. Создается движок sqlalchemy.create_engine для определенного типа бд. В нашем случае для PostgerSQL. Ссылка на PostgerSQL бд выглядит примерно так: postgresql://username:password@host:port/database_name .
    2. Создается sessionmaker, объект, который позволяет создавать сессии для работы с бд.
2. При работе приложения<br>
    1. Или с помощью оператора with создается сессия или сессия создается автоматически перед тем, как начнет выполняться код, на которую вела ссылка.
        1. С помощью декоратора Flask before_request перехватывается вызов функции ссылки. Далее создается сессия с бд и объект помещается с параметр Flask.g – позволяющий переносить какие-либо объекты между областями видимости функций.
        2. С помощью декоратора Flask after_request перехватывается событие завершения выполнения кода ссылкы. Тут и закрывается сессия с бд с помощью вызова метода close() у активной сессии.
    2. Выполняется любая задача, требующая соединения с бд. После чего коннект с бд закрывается автоматически или необходимо вызвать метод close() у активной сессии, если не был использованы варианты соединения с бд, описанные в пунктах 2.1.1 и 2.1.2.

**Алгоритм обработки запросов от пользователя:**
1) Обычные ссылки перехватываются Flask декоратором route, который позволяет соединить ссылку с функцией, обрабатывающей эту ссылку. 
2)  Ссылки, ведущий на апи к нашему сайту реализованы через архитектурный стиль программирования RESTful. Перехваткой запросов от пользователя занимается внутренняя реализация библиотеки flask_restful. От нас требуется лишь создать какой либо класс ресурса и зарегистрировать его с помощью вызова Flask. add_resource. 
Кроме библиотеки flask_restful, также был использован класс Flask. Blueprint, который также позволяется перехватывать события от пользователя через декоратор route.

**Алгоритм загрузки данных в шаблоны.<br>**

В проекте использован шаблонизатор Jinja. При загрузке шаблона на html через python с использованием render_template(args), в функцию добавляются аргументы, к которым впоследствии можно будет обращаться через синтаксис Jinja. Также Jinja предоставляет огромный набор инструментов для работы с любыми объектами python. 

**Алгоритм создания билетов и отправка их на почту:**
1) Из шаблона через POST запрос мы получаем данные о заказанных билетах.
2) Функция make_order() занимается обработкой данных, вызывает функцию create_places(), а также вызывает функцию send_mail().
3) Функция create_places() перебирает список с выбранными местами и создает объект Place, в котором хранится информация о месте, сеансе, а также уникальный код, который позволяет идентифицировать заказанный билет.
4) Функция  send_mail() запускается в отдельном потоке с использованием библиотеки threading. Функция формирует объект письма, создает картинки билетов с использованием класса Ticket, который возвращает картинку в байтах. Далее созданные билеты добавляются во вложения к письму.
5) После подготовки объекта письма оно отправляется на указанный адрес с помощью библиотеки smtplib.
Зачастую, такие сервисы почт, как Yandex.Mail, распознают наше письмо как спам. В результате оно оказывается в папке спама. И чтобы предупредить пользователя, после заказа билета, на странице всплывает подсказка о том, что билеты отправлены, и могут оказаться в спаме. 
Также хочется отметить и работу класса Ticket, который формирует картинку билета с использованием библиотеки PIL. Данный класс открывает шаблон билета, и заполняет его переданными данными. Также при заполнении используется библиотека qrcode, которая позволяет сформировать картинку и отобразить ее через инструменты PIL.

<h3>Описание реализации некоторых алгоритмов в проекте</h3><a name='Descrip-implem-some-algorithms'></a>
Для обработки пользовательских запросов были применены декораторы flask.route, который перехватывают запрос и вызывают ту или иную функцию. Также для добавления апи к нашему проекту, были использованы библиотеки flask_restful и Flask.Blueprint. Перечисленные библиотеки позволяют реализовать апи взаимодействия с данными в нашем проекте. Реализованы апи как для получения, удаления и изменения какого-то конкретного фильма или сессии на фильм, получения списка фильмов и сессий, так и для получения списка популярных фильмов и новых фильмов (тех, у кого дата премьеры была в текущем месяце).  Также доступно апи для поиска фильмов по определенным параметрам (году, жанрам, продолжительности, названию, режиссеру). 

Результат апи возвращается в формате json, с помощью вызова функции jsonify. Данная функция формирует json объект, используя сериализацию классов данных бд (которая наследуется от SerializerMixin). 

Работа апи основана на библиотеке Sqlalchemy. Библиотека позволяет подключаться к базам данных и получать какие-либо данные или добавлять и изменять существующие. В проекте соединения с базой происходит при вызове create_engine ().  Последующие подключения происходят при вызове объекта sessionmaker. Объект создает подключение к бд, и с помощью query(), и  filter() позволяет получать различные типы, фильтруемые по различным критериям.

Создание таблиц в бд происходил посредством формирования класса, который передается в create_engine. Подобный класс должен наследоваться от SqlAlchemyBase. Чтобы класс был полноценной таблицей, ему нужно задать параметры, которые станут колонками в бд. Создание подобных параметров происходит с помощью sqlalchemy.Column(), куда передается какой тип данных будет хранить колонка и различные другие парамтеры.

Отрисовка шаблонов происходит с помощью вызова render_template(). В функцию передается шаблон, который необходимо отобразить, и данные, которые будут переданы в шаблон для заполнения. 

Шаблоны заполняются с использованием инструментов Jinja. Jinja позволяет использовать, как циклы и проверки в html шаблоне, так и методы объектов python. 

Администраторский интерфейс создан с использование flask_admin. Библиотека позволяет использовать созданные шаблоны по работе с бд. Также имеется возможность полностью вручную настроить отображение данные в админке. Достаточно создать класс, унаследованный от ModelView из flask_admin.contrib.sqla. flask_admin имеет множество различных параметров, изменяя которые можно получить свой собственный, ни на что не похожий, интерфейс.

Хочется также уделить внимание и реализации алгоритма авто очищения бд от устаревших данных о сессиях и связанных с ними местами. Для реализации подобного алгоритма была использована библиотека apscheduler. В данной библиотеке имеются различные типы запуска таймера. Тут следует остановить поподробнее. При локальном запуске нашего приложения активируется apscheduler.schedulers.background, который позволяет выполнять несколько процессов одновременно, не блокируя выполнение основного кода. Однако для удаленного сервера на Heroku требуется apscheduler.schedulers.blocking. Именно из-за этого в корне проекта лежат два файла, выполняющих одинаковую работу, но делающие ее по разным алгоритмам.

Сам процесс удаления не представляет собой чего-то сверхъественного. Каждые вторник и пятницу в 15 часов дня запускается код, который получает из базы данные, которые были добавлены 1 неделю назад, и удаляет их. Тем самым происходит автоматическое самоочищение базы. 

<h3>Заключение</h3><a name='End'></a>
* Цель и задачи, поставленные в работе, выполнены. <br>
* Создан сайт «FilmCenter», имеющий интуитивно-понятный графический интерфейс пользователя. <br>
* Для реализации была выбрана среда разработки Pycharm, библиотеки Flask, Sqlalchemy, flask_restful, flask_admin и др. Программа предоставляет возможность ознакомиться с множеством фильмов, а также купить билет на доступный сеанс. 